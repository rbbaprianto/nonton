name: Deploy Nonton

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
        with:
          version: "latest"

      - name: Create App
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if ! flyctl apps list | grep -q "nonton"; then
            flyctl apps create nonton \
              --name nonton \
              --org personal
          fi
          echo "primary_region = \"sin\"" >> fly.toml

      - name: Deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --app nonton --remote-only --verbose

  cleanup:
    needs: deploy
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const currentWorkflowId = context.payload.workflow.id;
            const currentRunId = context.runId;
            
            const toDelete = runs.workflow_runs
              .filter(run => 
                run.id !== currentRunId && 
                run.status === 'completed' && 
                new Date(run.created_at) < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
              )
              .slice(5);
            
            for (const run of toDelete) {
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}